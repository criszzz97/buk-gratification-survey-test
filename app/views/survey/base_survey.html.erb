<!-- app/views/surveys/_form.html.erb -->
<form action="<%= base_survey_path %>" method="get" id="survey-form">
  <div class="form-group">
    <label for="country-select">País del colaborador</label>
    <select id="country-select" name="survey[country]" class="form-control" required>
      <option value="">– select –</option>
      <%= options_for_select(@country_options, params.dig(:survey, :country)) %>
    </select>
  </div>

  <div id="dynamic-fields">
    <!-- codigo dinamico de de campos -->
  </div>

  <button type="submit" id="calculate-button" class="btn btn-primary" disabled>Calcular</button>

  <div class="form-group mt-3" id="result-container" style="display: none">
    <label for="result-label-detail">Detalle</label>
    <input type="text" readonly class="form-control" id="result-field-detail" value="">
    <label for="result-label-amount">Monto</label>
    <input type="text" readonly class="form-control" id="result-field-amount" value="">
    <label for="result-label-currency">Moneda</label>
    <input type="text" readonly class="form-control" id="result-field-currency" value="">
  </div>

</form>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const countrySelect = document.getElementById("country-select");
    const dynamicFieldToFill = document.getElementById("dynamic-fields");
    const calculateButton = document.getElementById("calculate-button");
    const resultContainer = document.getElementById("result-container");
    const resultFieldDetails = document.getElementById("result-field-detail");
    const resultFieldAmount = document.getElementById("result-field-amount");
    const resultFieldCurrency = document.getElementById("result-field-currency");
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    var country = "";

    countrySelect.addEventListener("change", function () {
      resultContainer.style.display = 'none';

      country = this.value;
      resultFieldDetails.value = "";
      resultFieldAmount.value = "";
      resultFieldCurrency.value = "";

      calculateButton.disabled = !country

      if (!country) {
        dynamicFieldToFill.innerHTML = ""
        console.log("No country was selected")
        return
      }

      console.log("selected country:", country);
      fetch(
        `<%= survey_gratification_path %>?country=${encodeURIComponent(country)}`,
        { headers: { "Accept": "text/html" } }
      )
        .then(r => r.ok ? r.text() : Promise.reject(r.statusText))
        .then(html => {
          dynamicFieldToFill.innerHTML = html;
        })
        .catch(console.error);
    });


    calculateButton.addEventListener("click", (event) => {

      
      // If you want to stop the form from actually submitting,
      // uncomment the next line:
      event.preventDefault();

      console.log("Calculate button was pressed!");

      const input = Array.from(document.querySelectorAll("[data-dynamic-input]")).reduce((acc, currentValue) => {
        acc[currentValue.name] = currentValue.value
        return acc
      }, {});

      input["country"] = country;
      console.log({ input })

      let details = "";
      let amount = "";
      let currency = "";

      fetch(`<%= calculate_gratification_path %>`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',       
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken 
        },
        body: JSON.stringify({input})               
      })
        .then(response => {
          if (!response.ok) throw new Error(response.statusText);
          return response.json();                   
        })
        .then(data => {
          console.log('Got back:', data);
          details = data?.data?.details || '';
          amount = data?.data?.amount || '';
          currency = data?.data?.currency || '';
          resultFieldDetails.value = details;
          resultFieldCurrency.value = currency
          resultFieldAmount.value = String(amount);
        })
        .catch(err => {
          console.error('The input couldnt be loaded: ', err);
        });


      resultContainer.style.display = 'block';

    });
  });
</script>